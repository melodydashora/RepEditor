<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repository Configuration - RepEditor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 40px 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        .section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .section h2 {
            color: #a78bfa;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        .field {
            margin-bottom: 25px;
        }
        .field label {
            display: block;
            color: #cbd5e1;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .field input, .field textarea {
            width: 100%;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 12px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }
        .field textarea {
            min-height: 120px;
            resize: vertical;
        }
        .field input:focus, .field textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #475569;
        }
        .btn-secondary:hover {
            background: #334155;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        .info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #cbd5e1;
            font-size: 0.9em;
        }
        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .ssh-display {
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Agent Configuration</h1>
        <p class="subtitle">Configure repository access and SSH keys for AI assistant</p>

        <!-- SSH Key Section -->
        <div class="section">
            <h2>üîë SSH Key Generation</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                Generate SSH keypairs for the agent to access external repositories
            </p>
            
            <div class="btn-group">
                <button class="btn" onclick="generateSSHKey()">Generate New SSH Key</button>
                <button class="btn btn-secondary" onclick="viewExistingKeys()">View Existing Keys</button>
            </div>

            <div id="ssh-output" style="margin-top: 20px;"></div>
        </div>

        <!-- Repository Access Token Section -->
        <div class="section">
            <h2>üîê Repository Access Token</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                Token-based authentication for repo-to-repo access across AI models
            </p>

            <div class="field">
                <label for="repo-token">Repository Access Token</label>
                <input 
                    type="text" 
                    id="repo-token" 
                    placeholder="Enter your repository access token"
                    value=""
                >
            </div>

            <div class="field">
                <label for="repo-url">External Repository URL (Optional)</label>
                <input 
                    type="text" 
                    id="repo-url" 
                    placeholder="https://github.com/username/repo.git"
                >
            </div>

            <div class="btn-group">
                <button class="btn" onclick="saveToken()">Save Token</button>
                <button class="btn" onclick="generateToken()">Generate New Token</button>
                <button class="btn btn-secondary" onclick="testToken()">Test Connection</button>
            </div>

            <div class="info" style="margin-top: 20px;">
                <strong>üí° How it works:</strong><br>
                This token allows any AI model (including codex, GPT-5, etc.) to access repository files and tools, 
                even if they don't natively support function calling.
            </div>

            <div id="token-status" style="margin-top: 15px;"></div>
        </div>

        <!-- Permissions Section -->
        <div class="section">
            <h2>‚öôÔ∏è Agent Permissions</h2>
            <p style="color: #94a3b8; margin-bottom: 20px;">
                Control what the AI assistant can access and modify
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="perm-read" checked>
                    <span>Read Files</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="perm-write" checked>
                    <span>Write Files</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="perm-execute" checked>
                    <span>Execute Commands</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="perm-git" checked>
                    <span>Git Operations</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="perm-web" checked>
                    <span>Web Search</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="perm-memory" checked>
                    <span>Memory Access</span>
                </label>
            </div>

            <div class="btn-group" style="margin-top: 25px;">
                <button class="btn" onclick="savePermissions()">Save Permissions</button>
                <button class="btn btn-secondary" onclick="resetPermissions()">Reset to Defaults</button>
            </div>
        </div>

        <!-- Back to Chat -->
        <div style="text-align: center; margin-top: 30px;">
            <a href="/chat" style="color: #667eea; text-decoration: none; font-size: 1.1em;">
                ‚Üê Back to AI Assistant
            </a>
        </div>
    </div>

    <script>
        // Generate SSH Key
        async function generateSSHKey() {
            const output = document.getElementById('ssh-output');
            output.innerHTML = '<div class="info">Generating SSH keypair...</div>';

            try {
                const response = await fetch('/api/config/ssh/generate', {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    output.innerHTML = `
                        <div class="info success">
                            ‚úÖ SSH key generated successfully!
                        </div>
                        <div style="margin-top: 15px;">
                            <strong style="color: #a78bfa;">Public Key:</strong>
                            <div class="ssh-display">${data.public_key}</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong style="color: #a78bfa;">Private Key Path:</strong>
                            <code>${data.private_key_path}</code>
                        </div>
                        <div class="info" style="margin-top: 15px;">
                            Add the public key to your Git provider (GitHub, GitLab, etc.) to enable repository access.
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to generate SSH key');
                }
            } catch (error) {
                output.innerHTML = `<div class="info error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // View Existing Keys
        async function viewExistingKeys() {
            const output = document.getElementById('ssh-output');
            output.innerHTML = '<div class="info">Loading SSH keys...</div>';

            try {
                const response = await fetch('/api/config/ssh/list');
                const data = await response.json();

                if (response.ok && data.keys && data.keys.length > 0) {
                    const keysList = data.keys.map(key => `
                        <div style="margin-bottom: 15px;">
                            <strong>${key.name}</strong><br>
                            <code style="font-size: 0.85em;">${key.path}</code>
                        </div>
                    `).join('');

                    output.innerHTML = `
                        <div class="info success">Found ${data.keys.length} SSH key(s)</div>
                        <div style="margin-top: 15px;">${keysList}</div>
                    `;
                } else {
                    output.innerHTML = '<div class="info">No existing SSH keys found. Generate a new one to get started.</div>';
                }
            } catch (error) {
                output.innerHTML = `<div class="info error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Generate Repository Token
        async function generateToken() {
            try {
                const response = await fetch('/api/config/token/generate', {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('repo-token').value = data.token;
                    document.getElementById('token-status').innerHTML = `
                        <div class="info success">
                            ‚úÖ New access token generated! Copy and save it securely.
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to generate token');
                }
            } catch (error) {
                document.getElementById('token-status').innerHTML = `
                    <div class="info error">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        // Save Token
        async function saveToken() {
            const token = document.getElementById('repo-token').value;
            const repoUrl = document.getElementById('repo-url').value;

            if (!token) {
                document.getElementById('token-status').innerHTML = `
                    <div class="info error">‚ùå Please enter a token</div>
                `;
                return;
            }

            try {
                const response = await fetch('/api/config/token/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, repo_url: repoUrl })
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('token-status').innerHTML = `
                        <div class="info success">‚úÖ Token saved successfully!</div>
                    `;
                } else {
                    throw new Error(data.detail || 'Failed to save token');
                }
            } catch (error) {
                document.getElementById('token-status').innerHTML = `
                    <div class="info error">‚ùå Error: ${error.message}</div>
                `;
            }
        }

        // Test Token
        async function testToken() {
            const token = document.getElementById('repo-token').value;

            if (!token) {
                document.getElementById('token-status').innerHTML = `
                    <div class="info error">‚ùå Please enter a token first</div>
                `;
                return;
            }

            document.getElementById('token-status').innerHTML = `
                <div class="info">Testing connection...</div>
            `;

            try {
                const response = await fetch('/api/config/token/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('token-status').innerHTML = `
                        <div class="info success">
                            ‚úÖ Connection successful!<br>
                            Access level: ${data.access_level || 'Full'}<br>
                            Repository: ${data.repo || 'Local'}
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Connection test failed');
                }
            } catch (error) {
                document.getElementById('token-status').innerHTML = `
                    <div class="info error">‚ùå Connection failed: ${error.message}</div>
                `;
            }
        }

        // Save Permissions
        async function savePermissions() {
            const permissions = {
                read: document.getElementById('perm-read').checked,
                write: document.getElementById('perm-write').checked,
                execute: document.getElementById('perm-execute').checked,
                git: document.getElementById('perm-git').checked,
                web: document.getElementById('perm-web').checked,
                memory: document.getElementById('perm-memory').checked
            };

            try {
                const response = await fetch('/api/config/permissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(permissions)
                });

                if (response.ok) {
                    alert('‚úÖ Permissions saved successfully!');
                } else {
                    throw new Error('Failed to save permissions');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Reset Permissions
        function resetPermissions() {
            document.getElementById('perm-read').checked = true;
            document.getElementById('perm-write').checked = true;
            document.getElementById('perm-execute').checked = true;
            document.getElementById('perm-git').checked = true;
            document.getElementById('perm-web').checked = true;
            document.getElementById('perm-memory').checked = true;
        }

        // Load saved token on page load
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/config/token/current');
                if (response.ok) {
                    const data = await response.json();
                    if (data.token) {
                        document.getElementById('repo-token').value = data.token;
                        document.getElementById('token-status').innerHTML = `
                            <div class="info">Token loaded from saved configuration</div>
                        `;
                    }
                }
            } catch (error) {
                console.log('No saved token found');
            }
        });
    </script>
</body>
</html>
